---
// 引入 Svelte 组件
import ElmWrapper from '../components/ElmWrapper.svelte';
import { S3Client, ListObjectsV2Command } from "@aws-sdk/client-s3";
import postgres from 'postgres';

// --- SSR 服务端逻辑区 ---

// 生成随机目标数字 (7-15)
const targetNumber = Math.floor(Math.random() * 9) + 7;

// 1. 测试连接 Neon 数据库
const sql = postgres(import.meta.env.DATABASE_URL);
// 假设你数据库里有个叫 posts 的表，没有的话这行会报错，先注释掉测试
// const posts = await sql`select * from posts`;

// 2. 测试连接 C2 存储
const s3 = new S3Client({
  region: import.meta.env.S3_REGION,
  endpoint: import.meta.env.S3_ENDPOINT,
  credentials: {
    accessKeyId: import.meta.env.S3_ACCESS_KEY,
    secretAccessKey: import.meta.env.S3_SECRET_KEY,
  },
});

// 如果成功，返回数组；如果失败，打印错误并返回空数组
const files = await s3
  .send(new ListObjectsV2Command({ Bucket: import.meta.env.S3_BUCKET }))
  .then((res) => res.Contents || [])
  .catch((err) => {
    console.error("S3 连接失败:", err);
    return []; // 发生错误时的默认值
  });

// 尝试列出文件
// const command = new ListObjectsV2Command({ Bucket: import.meta.env.S3_BUCKET });
// const files = await s3.send(command);
---

<html lang="zh-CN">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>我的全栈博客</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}
			body {
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: center;
				min-height: 100vh;
				padding: 2rem;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			}
			h1, p {
				color: white;
				text-align: center;
				margin-bottom: 1.5rem;
			}
			h1 {
				font-size: 2.5rem;
				margin-bottom: 1rem;
			}
			p {
				font-size: 1.1rem;
				margin-bottom: 2rem;
			}
		</style>
	</head>
	<body>
		<h1>Astro + Svelte + Elm</h1>
		
		<p>将计数器加到 <span style="color: #ffd700; font-weight: bold;">{targetNumber}</span> 来访问个人主页</p>
		
		<!-- client:load 意思是：页面加载时立即在客户端激活 JS -->
		<!-- 如果不加 client:load，它就是静态 HTML，Elm 动不了 -->
		<ElmWrapper targetNumber={targetNumber} client:load />

	</body>
</html>


